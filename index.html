<!DOCTYPE html>

<html lang="es">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>TechNova S.A.C. | Sistema de Gestión v2.0</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>

        :root { --primary: #3ecf8e; --primary-dark: #2eb875; --dark: #1e1e1e; --danger: #ff4d4f; --gray: #8c8c8c; }

        body { font-family: 'Inter', system-ui, sans-serif; background: #f4f7f6; margin: 0; color: #333; }

        .container { max-width: 1000px; margin: 40px auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

       

        /* Header */

        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }

        .logo-area h1 { margin: 0; font-size: 24px; color: var(--dark); }

        .user-pill { background: #f0f0f0; padding: 8px 16px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }


        /* Forms */

        .card { background: #fafafa; border: 1px solid #eaeaea; padding: 25px; border-radius: 12px; margin-bottom: 30px; }

        .grid-form { display: grid; grid-template-columns: 2fr 2fr 1.5fr; gap: 15px; }

        input, select { padding: 12px; border: 1.5px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }

        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(62, 207, 142, 0.1); }

       

        /* Buttons */

        button { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }

        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 15px; }

        .btn-main:hover { background: var(--primary-dark); transform: translateY(-1px); }

        .btn-outline { background: transparent; border: 1.5px solid #ddd; color: var(--gray); }

        .btn-danger { background: #fff1f0; color: var(--danger); border: 1px solid #ffa39e; padding: 5px 12px; font-size: 13px; }

        .btn-danger:hover { background: var(--danger); color: white; }


        /* Table */

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }

        th { text-align: left; padding: 12px; color: var(--gray); font-weight: 500; font-size: 13px; }

        td { padding: 16px 12px; background: white; border-top: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; }

        td:first-child { border-left: 1px solid #f0f0f0; border-radius: 8px 0 0 8px; }

        td:last-child { border-right: 1px solid #f0f0f0; border-radius: 0 8px 8px 0; }

       

        .status { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }

        .status-activo { background: #e6fffa; color: #147d64; }

        .status-inactivo { background: #fff1f0; color: #cf1322; }

       

        .hidden { display: none; }

        .loader { color: var(--primary); font-weight: bold; text-align: center; padding: 20px; }

    </style>

</head>

<body>


<div class="container">

    <div id="view-auth">

        <div style="text-align: center; margin-bottom: 30px;">

            <h1 style="color: var(--dark)">TechNova S.A.C.</h1>

            <p style="color: var(--gray)">Acceso al Sistema de Gestión de Clientes</p>

        </div>

        <div class="card">

            <input type="email" id="login-email" placeholder="Correo institucional" style="width: 100%; margin-bottom: 15px;">

            <input type="password" id="login-pass" placeholder="Contraseña" style="width: 100%; margin-bottom: 15px;">

            <button class="btn-main" onclick="app.handleSignIn()">Entrar al Sistema</button>

            <p style="text-align: center; font-size: 14px; color: var(--gray); margin-top: 20px;">

                ¿Eres nuevo? <a href="#" onclick="app.handleSignUp()" style="color: var(--primary)">Regístrate como Empleado</a>

            </p>

        </div>

    </div>


    <div id="view-app" class="hidden">

        <header class="header">

            <div class="logo-area">

                <h1>Panel Administrativo</h1>

                <span id="role-tag" class="status status-activo" style="font-size: 10px;">Cargando...</span>

            </div>

            <div class="user-pill">

                <span id="user-email" style="font-weight: 500;"></span>

                <button class="btn-outline" onclick="app.handleSignOut()" style="padding: 5px 10px; font-size: 12px;">Salir</button>

            </div>

        </header>


        <section class="card">

            <h3>+ Registrar Nuevo Cliente</h3>

            <div class="grid-form">

                <input type="text" id="c-nombre" placeholder="Nombre del cliente">

                <input type="email" id="c-email" placeholder="Email de contacto">

                <select id="c-estado">

                    <option value="ACTIVO">ACTIVO</option>

                    <option value="INACTIVO">INACTIVO</option>

                </select>

            </div>

            <button class="btn-main" onclick="app.createClient()">Confirmar Registro</button>

        </section>


        <section>

            <h3>Base de Datos de Clientes</h3>

            <div id="loading" class="loader hidden">Sincronizando con Supabase...</div>

            <table id="table-clients">

                <thead>

                    <tr>

                        <th>ID</th>

                        <th>NOMBRE</th>

                        <th>EMAIL</th>

                        <th>ESTADO</th>

                        <th>ACCIONES</th>

                    </tr>

                </thead>

                <tbody></tbody>

            </table>

        </section>

    </div>

</div>


<script>

    /**

     * CLASE TÉCNICA: TechNovaAPI

     * Aplica los principios de POO y encapsulamiento solicitados.

     */

    class TechNovaAPI {

        constructor(url, key) {

            this.client = supabase.createClient(url, key);

            this.user = null;

            this.role = 'Empleado';

        }


        // --- Manejo de Sesión ---

        async handleSignUp() {

            const email = document.getElementById('login-email').value;

            const pass = document.getElementById('login-pass').value;

            const { error } = await this.client.auth.signUp({ email, password: pass });

            if (error) alert("Error: " + error.message);

            else alert("Registro exitoso. Ahora inicia sesión.");

        }


        async handleSignIn() {

            const email = document.getElementById('login-email').value;

            const pass = document.getElementById('login-pass').value;

            const { data, error } = await this.client.auth.signInWithPassword({ email, password: pass });

           

            if (error) return alert("Acceso denegado: " + error.message);

           

            this.user = data.user;

            await this.initApp();

        }


        async initApp() {

            // Obtener rol desde la tabla profiles (implementado en tu SQL anterior)

            const { data } = await this.client.from('profiles').select('rol').eq('id', this.user.id).single();

            this.role = data ? data.rol : 'Empleado';


            document.getElementById('view-auth').classList.add('hidden');

            document.getElementById('view-app').classList.remove('hidden');

            document.getElementById('user-email').innerText = this.user.email;

            document.getElementById('role-tag').innerText = this.role.toUpperCase();

           

            this.loadClients();

        }


        // --- CRUD de Clientes ---

        async loadClients() {

            const loader = document.getElementById('loading');

            loader.classList.remove('hidden');

           

            const { data, error } = await this.client.from('clientes').select('*').order('id', { ascending: false });

            loader.classList.add('hidden');


            if (error) return console.error(error);

            this.renderTable(data);

        }


        async createClient() {

            const nombre = document.getElementById('c-nombre').value;

            const email = document.getElementById('c-email').value;

            const estado = document.getElementById('c-estado').value;


            if (!nombre || !email) return alert("Por favor complete todos los campos.");


            const { error } = await this.client.from('clientes').insert([

                { nombre, email, estado, creado_por: this.user.id }

            ]);


            if (error) alert("Error de permisos (RLS): " + error.message);

            else {

                this.loadClients();

                this.resetForm();

            }

        }


        async deleteClient(id) {

            if (!confirm("¿Está seguro de eliminar este registro?")) return;

           

            const { error } = await this.client.from('clientes').delete().eq('id', id);

           

            if (error) {

                alert("Violación de política RLS: No tienes permiso para borrar este cliente.");

            } else {

                this.loadClients();

            }

        }


        // --- Utilidades de Interfaz ---

        renderTable(data) {

            const tbody = document.querySelector('#table-clients tbody');

            tbody.innerHTML = '';


            data.forEach(item => {

                // Lógica de permisos visuales

                const puedeBorrar = (item.creado_por === this.user.id || this.role === 'Admin');

                const btnAction = puedeBorrar

                    ? `<button class="btn-danger" onclick="app.deleteClient(${item.id})">Eliminar</button>`

                    : `<span style="color:#ccc; font-size:11px;">Restringido</span>`;


                tbody.innerHTML += `

                    <tr>

                        <td style="font-weight:bold; color:var(--primary)">#${item.id}</td>

                        <td>${item.nombre}</td>

                        <td>${item.email}</td>

                        <td><span class="status status-${item.estado.toLowerCase()}">${item.estado}</span></td>

                        <td>${btnAction}</td>

                    </tr>

                `;

            });

        }


        resetForm() {

            document.getElementById('c-nombre').value = '';

            document.getElementById('c-email').value = '';

        }


        async handleSignOut() {

            await this.client.auth.signOut();

            location.reload();

        }

    }


    // Instanciación de la Aplicación

    const app = new TechNovaAPI(

        'https://cokbacjzqwbracyvlywn.supabase.co',

        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNva2JhY2p6cXdicmFjeXZseXduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NjQ4MTksImV4cCI6MjA4NjE0MDgxOX0.n-pC1ekZR6cyFWSn-1aH3aO97f0CWPoOc8jdh1B9C48'

    );

</script>

</body>

</html>